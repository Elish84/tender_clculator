<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>מחשבון ניקוד מכרז (טכני+כלכלי)</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121a33; --muted:#9fb1ff; --text:#eef2ff;
      --line:rgba(255,255,255,.12); --good:#33d17a; --warn:#ffb020; --bad:#ff4d4d;
      --radius:16px;
    }
    *{ box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body{ margin:0; background:linear-gradient(180deg,#070a14,#0b1020 45%,#070a14); color:var(--text); }
    header{ position:sticky; top:0; z-index:50; backdrop-filter: blur(10px);
      background:rgba(7,10,20,.7); border-bottom:1px solid var(--line); }
    .wrap{ max-width:1100px; margin:0 auto; padding:14px 14px; }
    h1{ font-size:18px; margin:0; }
    .sub{ color:rgba(238,242,255,.75); font-size:13px; margin-top:4px; line-height:1.3; }

    .tabs{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .tabbtn{
      border:1px solid var(--line); background:rgba(18,26,51,.55); color:var(--text);
      padding:10px 12px; border-radius:999px; cursor:pointer; font-weight:700; font-size:13px;
    }
    .tabbtn.active{ outline:2px solid rgba(159,177,255,.35); background:rgba(18,26,51,.9); }
    main{ padding:14px; }
    .card{ background:rgba(18,26,51,.75); border:1px solid var(--line); border-radius:var(--radius);
      padding:14px; margin-bottom:14px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
    .field{ display:flex; flex-direction:column; gap:6px; min-width:160px; flex:1; }
    label{ font-size:12px; color:rgba(238,242,255,.8); }
    input, select{
      width:100%; padding:10px 10px; border-radius:12px; border:1px solid var(--line);
      background:rgba(7,10,20,.55); color:var(--text); outline:none;
    }
    input[type="number"]{ text-align:left; direction:ltr; }
    .btn{
      padding:10px 12px; border-radius:12px; border:1px solid var(--line);
      background:rgba(159,177,255,.12); color:var(--text); cursor:pointer; font-weight:800;
    }
    .btn.danger{ background:rgba(255,77,77,.12); }
    .btn.good{ background:rgba(51,209,122,.12); }
    .hint{ font-size:12px; color:rgba(238,242,255,.7); margin-top:6px; line-height:1.35; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 820px){ .grid2{ grid-template-columns:1fr; } }

    table{ width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:14px; }
    th,td{ border-bottom:1px solid var(--line); padding:10px 8px; font-size:13px; }
    th{ text-align:right; color:rgba(238,242,255,.85); background:rgba(7,10,20,.35); position:sticky; top:0; }
    tr:last-child td{ border-bottom:none; }
    .right{ text-align:right; }
    .ltr{ direction:ltr; text-align:left; }
    .pill{ display:inline-flex; gap:6px; align-items:center; padding:4px 10px; border:1px solid var(--line);
      border-radius:999px; font-size:12px; background:rgba(7,10,20,.35); }
    .ok{ color:var(--good); font-weight:900; }
    .warn{ color:var(--warn); font-weight:900; }
    .bad{ color:var(--bad); font-weight:900; }
    details{ border:1px dashed var(--line); border-radius:14px; padding:10px; background:rgba(7,10,20,.25); }
    summary{ cursor:pointer; font-weight:800; }
    .sep{ height:1px; background:var(--line); margin:10px 0; }

    .small{ font-size:12px; color:rgba(238,242,255,.75); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>מחשבון ניקוד מכרז – טכני/ניהולי + כלכלי</h1>
    <div class="sub">
      מחשב: <span class="mono">PTotal = 0.3·P_TM + 0.7·P_FinanceScore</span> <br/>
      כלכלי לפי עלות משוקללת: <span class="mono">P_finance_cost = 0.98·PF_fixed + 0.02·P_T&M</span> ואז ניקוד יחסי לפי הזול ביותר.
    </div>

    <div class="tabs" id="tabs">
      <button class="tabbtn active" data-tab="tab1">1) מציעים</button>
      <button class="tabbtn" data-tab="tab2">2) טכני-ניהולי</button>
      <button class="tabbtn" data-tab="tab3">3) כלכלי</button>
      <button class="tabbtn" data-tab="tab4">4) תוצאות</button>
      <button class="tabbtn" data-tab="tab5">הגדרות</button>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- TAB 1 -->
  <section id="tab1" class="card">
    <h2 style="margin:0 0 10px 0; font-size:16px;">מציעים</h2>
    <div class="row">
      <div class="field" style="min-width:240px; flex:2;">
        <label>שם מציע חדש</label>
        <input id="newBidderName" placeholder="לדוגמה: מציע א׳" />
      </div>
      <button class="btn good" id="btnAddBidder">הוסף מציע</button>
      <button class="btn" id="btnLoadExample">טען דוגמה</button>
      <button class="btn danger" id="btnClearAll">נקה הכל</button>
    </div>
    <div class="hint">
      טיפ: אם אתה רק רוצה לחשב מציע יחיד — תוסיף מציע אחד בלבד, והזול ביותר יהיה הוא עצמו (FinanceScore=100).
      כדי לקבל ניקוד אמיתי, כדאי להכניס לפחות 2 מציעים.
    </div>

    <div class="sep"></div>

    <div id="biddersList"></div>
  </section>

  <!-- TAB 2 -->
  <section id="tab2" class="card" style="display:none;">
    <h2 style="margin:0 0 10px 0; font-size:16px;">טכני-ניהולי (P_TM)</h2>

    <details open>
      <summary>משקולות לפי הטבלה (1.1.1–1.1.8)</summary>
      <div class="small" style="margin-top:8px;">
        כאן אנחנו מחשבים <span class="mono">P_TM</span> כסכום משוקלל של ציונים (0–100) לכל סעיף:
        <ul>
          <li>1.1.1 = 10%</li>
          <li>1.1.2 = 10%</li>
          <li>1.1.3 = 5%</li>
          <li>1.1.4 = 5%</li>
          <li>1.1.5 = 10%</li>
          <li>1.1.6 = 15%</li>
          <li>1.1.7 = 15%</li>
          <li>1.1.8 = 20%</li>
        </ul>
        אתה מזין ציון לכל סעיף עבור כל מציע (בדרך כלל ציון ועדה/בוחן).
      </div>
    </details>

    <div class="sep"></div>

    <div id="techInputs"></div>
  </section>

  <!-- TAB 3 -->
  <section id="tab3" class="card" style="display:none;">
    <h2 style="margin:0 0 10px 0; font-size:16px;">כלכלי (P_Finance)</h2>

    <details>
      <summary>מה המודל שהטמעתי כאן (בהתאם לנוסחאות בתמונות)</summary>
      <div class="small" style="margin-top:8px; line-height:1.45;">
        <div class="mono">
          PF3.1 = 25·0.1·x1 + 125·0.7·x2 + 350·0.7·x3 + 750·0.5·x4 + 1750·0.5·x5 + 3750·0.3·x6
          <br/>
          PF3.2 = 5·0.6·y1 + 30·0.8·y2 + 75.5·0.5·y3 + 150·0.4·y4
          <br/>
          PF_fixed = PF1 + Σ(prob_i·PF2.i) + PF3.1 + PF3.2
          <br/>
          P_finance_cost = 0.98·PF_fixed + 0.02·P_T&M
          <br/>
          FinanceScore = (min_cost / cost)·100
        </div>
        <div class="hint">
          הערה: אם אצלכם שיטת “ניקוד מחיר” שונה (למשל ליניארי סביב ממוצע/חציון) — תגיד לי ואשנה את נוסחת הניקוד בלחיצה.
        </div>
      </div>
    </details>

    <div class="sep"></div>

    <div id="financeInputs"></div>
  </section>

  <!-- TAB 4 -->
  <section id="tab4" class="card" style="display:none;">
    <h2 style="margin:0 0 10px 0; font-size:16px;">תוצאות</h2>

    <div class="row">
      <button class="btn" id="btnRecalc">חשב מחדש</button>
      <button class="btn" id="btnExportJson">ייצוא JSON</button>
      <button class="btn" id="btnExportCsv">ייצוא CSV</button>
    </div>

    <div class="sep"></div>

    <div id="results"></div>
  </section>

  <!-- TAB 5 -->
  <section id="tab5" class="card" style="display:none;">
    <h2 style="margin:0 0 10px 0; font-size:16px;">הגדרות</h2>

    <div class="grid2">
      <div class="card" style="margin:0;">
        <h3 style="margin:0 0 8px 0; font-size:14px;">משקולות עליונות</h3>
        <div class="row">
          <div class="field">
            <label>משקל טכני-ניהולי (ברירת מחדל 0.3)</label>
            <input type="number" step="0.01" id="wTech" value="0.3" />
          </div>
          <div class="field">
            <label>משקל כלכלי (ברירת מחדל 0.7)</label>
            <input type="number" step="0.01" id="wFin" value="0.7" />
          </div>
        </div>
        <div class="hint">המערכת תוודא שהסכום הוא 1. אם לא — היא תנרמל.</div>
      </div>

      <div class="card" style="margin:0;">
        <h3 style="margin:0 0 8px 0; font-size:14px;">T&M</h3>
        <div class="row">
          <div class="field">
            <label>שעות לשנה (ברירת מחדל 280)</label>
            <input type="number" step="1" id="tmHours" value="280" />
          </div>
          <div class="field">
            <label>תקרת הנחה % (ברירת מחדל 10)</label>
            <input type="number" step="0.1" id="tmDiscountCap" value="10" />
          </div>
          <div class="field">
            <label>משקל T&M בתוך כלכלי (ברירת מחדל 0.02)</label>
            <input type="number" step="0.001" id="tmWeightInFinance" value="0.02" />
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <h3 style="margin:0 0 8px 0; font-size:14px;">הסתברויות PF2 (ניתן לשינוי)</h3>
      <div class="small">ברירת מחדל לפי הטבלה בתמונה: PF2.1=60%, PF2.2=50%, PF2.3=20%, PF2.4=20%, PF2.5=50%, PF2.6=50%, PF2.7=80%, PF2.8=40%, PF2.9=20%, PF2.10=80%</div>
      <div id="pf2ProbEditor" class="row" style="margin-top:10px;"></div>
    </div>
  </section>

</main>

<script>
/* ========= Data Model ========= */
const DEFAULT_TECH_WEIGHTS = [
  { key:"1.1.1", label:"1.1.1", w:0.10 },
  { key:"1.1.2", label:"1.1.2", w:0.10 },
  { key:"1.1.3", label:"1.1.3", w:0.05 },
  { key:"1.1.4", label:"1.1.4", w:0.05 },
  { key:"1.1.5", label:"1.1.5", w:0.10 },
  { key:"1.1.6", label:"1.1.6", w:0.15 },
  { key:"1.1.7", label:"1.1.7", w:0.15 },
  { key:"1.1.8", label:"1.1.8", w:0.20 },
];

const PF2_KEYS = ["PF2.1","PF2.2","PF2.3","PF2.4","PF2.5","PF2.6","PF2.7","PF2.8","PF2.9","PF2.10"];
let state = loadState() ?? makeEmptyState();

function makeEmptyState(){
  return {
    bidders: [],
    settings: {
      wTech: 0.3,
      wFin: 0.7,
      tmHours: 280,
      tmDiscountCap: 10,
      tmWeightInFinance: 0.02,   // 2%
      pf2Prob: { // percentages
        "PF2.1":60, "PF2.2":50, "PF2.3":20, "PF2.4":20, "PF2.5":50,
        "PF2.6":50, "PF2.7":80, "PF2.8":40, "PF2.9":20, "PF2.10":80
      }
    }
  };
}

function makeBidder(name){
  const tech = {};
  DEFAULT_TECH_WEIGHTS.forEach(x => tech[x.key] = 0);

  const pf2 = {};
  PF2_KEYS.forEach(k => pf2[k] = 0);

  return {
    id: crypto.randomUUID(),
    name: name || "מציע",
    tech,
    finance: {
      PF1_fixed: 0,
      PF2: pf2,
      // PF3.1 tier unit prices x1..x6
      PF3_1_tiers: [0,0,0,0,0,0],
      // PF3.2 tier unit prices y1..y4
      PF3_2_tiers: [0,0,0,0],
      // T&M
      tm_hourly: 0,
      tm_discount_pct: 0
    }
  };
}

/* ========= Persistence ========= */
function saveState(){
  localStorage.setItem("tender_calc_state_v1", JSON.stringify(state));
}
function loadState(){
  try{
    const raw = localStorage.getItem("tender_calc_state_v1");
    if(!raw) return null;
    return JSON.parse(raw);
  }catch{ return null; }
}

/* ========= UI Helpers ========= */
const $ = (id) => document.getElementById(id);

function fmt(num, digits=2){
  const n = Number(num);
  if(!Number.isFinite(n)) return "—";
  return n.toLocaleString("he-IL", { maximumFractionDigits: digits, minimumFractionDigits: digits });
}
function clamp(n, a, b){
  n = Number(n);
  if(!Number.isFinite(n)) return a;
  return Math.min(b, Math.max(a, n));
}

/* ========= Calculations ========= */
function calcTechScore(b){
  // weighted sum of 0..100 scores
  let sum = 0;
  for(const item of DEFAULT_TECH_WEIGHTS){
    const s = clamp(b.tech[item.key], 0, 100);
    sum += item.w * s;
  }
  return sum; // already in 0..100
}

function calcPF3_1_cost(b){
  // PF3.1 = 25*0.1*x1 + 125*0.7*x2 + 350*0.7*x3 + 750*0.5*x4 + 1750*0.5*x5 + 3750*0.3*x6
  const x = b.finance.PF3_1_tiers.map(v => Number(v)||0);
  const terms = [
    {q:25,   p:0.1, v:x[0]},
    {q:125,  p:0.7, v:x[1]},
    {q:350,  p:0.7, v:x[2]},
    {q:750,  p:0.5, v:x[3]},
    {q:1750, p:0.5, v:x[4]},
    {q:3750, p:0.3, v:x[5]},
  ];
  return terms.reduce((acc,t)=> acc + t.q*t.p*t.v, 0);
}

function calcPF3_2_cost(b){
  // PF3.2 = 5*0.6*y1 + 30*0.8*y2 + 75.5*0.5*y3 + 150*0.4*y4
  const y = b.finance.PF3_2_tiers.map(v => Number(v)||0);
  const terms = [
    {q:5,   p:0.6, v:y[0]},
    {q:30,  p:0.8, v:y[1]},
    {q:75.5,p:0.5, v:y[2]},
    {q:150, p:0.4, v:y[3]},
  ];
  return terms.reduce((acc,t)=> acc + t.q*t.p*t.v, 0);
}

function calcPF_fixed_cost(b){
  const pf1 = Number(b.finance.PF1_fixed)||0;

  let pf2sum = 0;
  for(const k of PF2_KEYS){
    const price = Number(b.finance.PF2[k])||0;
    const probPct = Number(state.settings.pf2Prob[k])||0;
    pf2sum += price * (probPct/100);
  }

  const pf31 = calcPF3_1_cost(b);
  const pf32 = calcPF3_2_cost(b);

  return pf1 + pf2sum + pf31 + pf32;
}

function calcTM_cost(b){
  const hours = Number(state.settings.tmHours)||280;
  const cap = Number(state.settings.tmDiscountCap)||10;
  const hourly = Number(b.finance.tm_hourly)||0;
  const disc = clamp(b.finance.tm_discount_pct, 0, cap) / 100;
  return hours * hourly * (1 - disc);
}

function calcFinanceCost(b){
  // P_finance_cost = (1 - wTM)*PF_fixed + wTM*TM_cost
  const wTM = clamp(state.settings.tmWeightInFinance, 0, 1);
  const pfFixed = calcPF_fixed_cost(b);
  const tm = calcTM_cost(b);
  return (1 - wTM) * pfFixed + (wTM) * tm;
}

function calcAll(){
  // normalize top weights
  let wT = Number(state.settings.wTech);
  let wF = Number(state.settings.wFin);
  if(!Number.isFinite(wT)) wT = 0.3;
  if(!Number.isFinite(wF)) wF = 0.7;
  const sum = wT + wF;
  if(sum <= 0){ wT = 0.3; wF = 0.7; }
  else { wT = wT/sum; wF = wF/sum; }

  const rows = state.bidders.map(b => {
    const techScore = calcTechScore(b);
    const financeCost = calcFinanceCost(b);
    return { bidder:b, techScore, financeCost };
  });

  const minCost = rows.reduce((m,r)=> Math.min(m, r.financeCost), Infinity);
  for(const r of rows){
    const financeScore = (minCost > 0) ? (minCost / r.financeCost) * 100 : 0;
    r.financeScore = clamp(financeScore, 0, 100);
    r.totalScore = wT * r.techScore + wF * r.financeScore;
    r.pfFixed = calcPF_fixed_cost(r.bidder);
    r.pf31 = calcPF3_1_cost(r.bidder);
    r.pf32 = calcPF3_2_cost(r.bidder);
    r.tmCost = calcTM_cost(r.bidder);
  }

  rows.sort((a,b)=> b.totalScore - a.totalScore);
  return { rows, wT, wF, minCost };
}

/* ========= Rendering ========= */
function renderAll(){
  renderBiddersList();
  renderTechInputs();
  renderFinanceInputs();
  renderPf2ProbEditor();
  renderResults();
  saveState();
}

function renderBiddersList(){
  const el = $("biddersList");
  if(state.bidders.length === 0){
    el.innerHTML = `<div class="hint">אין מציעים עדיין. הוסף לפחות מציע אחד.</div>`;
    return;
  }

  el.innerHTML = state.bidders.map((b, idx) => `
    <div class="card" style="margin:0 0 10px 0;">
      <div class="row">
        <div class="field" style="min-width:240px; flex:2;">
          <label>שם מציע</label>
          <input value="${escapeHtml(b.name)}" data-act="rename" data-id="${b.id}" />
        </div>
        <div class="pill">ID: <span class="mono">${b.id.slice(0,8)}</span></div>
        <button class="btn danger" data-act="remove" data-id="${b.id}">מחק מציע</button>
      </div>
    </div>
  `).join("");

  el.querySelectorAll("[data-act='rename']").forEach(inp=>{
    inp.addEventListener("input", (e)=>{
      const id = e.target.dataset.id;
      const b = state.bidders.find(x=>x.id===id);
      if(b){ b.name = e.target.value; saveState(); renderResults(); }
    });
  });
  el.querySelectorAll("[data-act='remove']").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.dataset.id;
      state.bidders = state.bidders.filter(x=>x.id!==id);
      renderAll();
    });
  });
}

function renderTechInputs(){
  const el = $("techInputs");
  if(state.bidders.length === 0){
    el.innerHTML = `<div class="hint">הוסף מציעים כדי להזין ציוני טכני-ניהולי.</div>`;
    return;
  }

  const cols = DEFAULT_TECH_WEIGHTS.map(x=> `<th>${x.label}<div class="small">w=${(x.w*100).toFixed(0)}%</div></th>`).join("");
  const body = state.bidders.map(b=>{
    const cells = DEFAULT_TECH_WEIGHTS.map(x=>{
      const val = b.tech[x.key] ?? 0;
      return `<td class="ltr"><input type="number" min="0" max="100" step="1"
              value="${val}" data-act="tech" data-id="${b.id}" data-key="${x.key}"></td>`;
    }).join("");
    return `<tr><td class="right"><b>${escapeHtml(b.name)}</b></td>${cells}</tr>`;
  }).join("");

  el.innerHTML = `
    <div class="hint">הזן ציון (0–100) לכל סעיף עבור כל מציע.</div>
    <div style="overflow:auto; border:1px solid var(--line); border-radius:14px;">
      <table>
        <thead>
          <tr><th>מציע</th>${cols}</tr>
        </thead>
        <tbody>${body}</tbody>
      </table>
    </div>
  `;

  el.querySelectorAll("input[data-act='tech']").forEach(inp=>{
    inp.addEventListener("input", (e)=>{
      const id = e.target.dataset.id, key = e.target.dataset.key;
      const b = state.bidders.find(x=>x.id===id);
      if(!b) return;
      b.tech[key] = clamp(e.target.value, 0, 100);
      saveState();
      renderResults();
    });
  });
}

function renderFinanceInputs(){
  const el = $("financeInputs");
  if(state.bidders.length === 0){
    el.innerHTML = `<div class="hint">הוסף מציעים כדי להזין מחירים.</div>`;
    return;
  }

  el.innerHTML = state.bidders.map(b=>{
    const pf2Rows = PF2_KEYS.map(k=>{
      return `
        <div class="row" style="margin-bottom:8px;">
          <div class="field" style="min-width:140px; flex:1;">
            <label>${k} מחיר</label>
            <input type="number" step="0.01" value="${Number(b.finance.PF2[k])||0}"
              data-act="pf2" data-id="${b.id}" data-key="${k}" />
          </div>
          <div class="pill">הסתברות: <span class="mono">${Number(state.settings.pf2Prob[k])||0}%</span></div>
        </div>
      `;
    }).join("");

    const pf31 = b.finance.PF3_1_tiers;
    const pf32 = b.finance.PF3_2_tiers;

    return `
      <div class="card" style="margin:0 0 12px 0;">
        <h3 style="margin:0 0 10px 0; font-size:14px;">${escapeHtml(b.name)}</h3>

        <div class="grid2">
          <div class="card" style="margin:0;">
            <h4 style="margin:0 0 8px 0; font-size:13px;">PF1 (Fixed)</h4>
            <div class="row">
              <div class="field">
                <label>PF1_fixed (מחיר סל בסיס)</label>
                <input type="number" step="0.01" value="${Number(b.finance.PF1_fixed)||0}"
                  data-act="pf1" data-id="${b.id}" />
              </div>
            </div>
            <div class="hint">הכנס את המחיר הכולל של סל הבסיס (Fixed).</div>
          </div>

          <div class="card" style="margin:0;">
            <h4 style="margin:0 0 8px 0; font-size:13px;">T&amp;M</h4>
            <div class="row">
              <div class="field">
                <label>תעריף שעתי</label>
                <input type="number" step="0.01" value="${Number(b.finance.tm_hourly)||0}"
                  data-act="tm_hourly" data-id="${b.id}" />
              </div>
              <div class="field">
                <label>הנחה % (מוגבלת לפי תקרה בהגדרות)</label>
                <input type="number" step="0.1" value="${Number(b.finance.tm_discount_pct)||0}"
                  data-act="tm_disc" data-id="${b.id}" />
              </div>
            </div>
            <div class="hint">החישוב: שעות·תעריף·(1-הנחה).</div>
          </div>
        </div>

        <details style="margin-top:10px;">
          <summary>PF2 (אופציות פיתוח) – מחירים</summary>
          <div style="margin-top:10px;">${pf2Rows}</div>
        </details>

        <details style="margin-top:10px;">
          <summary>PF3.1 – מחיר רכש חלקי חילוף (x1..x6)</summary>
          <div class="hint">
            x1: 11–50 (10%), x2: 51–200 (70%), x3: 201–500 (70%), x4: 501–1000 (50%), x5: 1001–2500 (50%), x6: 2501–5000 (30%)
          </div>
          <div class="row" style="margin-top:10px;">
            ${pf31.map((v,i)=> `
              <div class="field" style="min-width:150px;">
                <label>x${i+1} (מחיר יחידה)</label>
                <input type="number" step="0.01" value="${Number(v)||0}" data-act="pf31" data-id="${b.id}" data-idx="${i}" />
              </div>
            `).join("")}
          </div>
        </details>

        <details style="margin-top:10px;">
          <summary>PF3.2 – מחיר רכש מערכות מלאות נוספות (y1..y4)</summary>
          <div class="hint">
            y1: 1–10 (60%), y2: 11–50 (80%), y3: 51–100 (50%), y4: 101–200 (40%)
          </div>
          <div class="row" style="margin-top:10px;">
            ${pf32.map((v,i)=> `
              <div class="field" style="min-width:150px;">
                <label>y${i+1} (מחיר יחידה)</label>
                <input type="number" step="0.01" value="${Number(v)||0}" data-act="pf32" data-id="${b.id}" data-idx="${i}" />
              </div>
            `).join("")}
          </div>
        </details>
      </div>
    `;
  }).join("");

  // listeners
  el.querySelectorAll("input[data-act='pf1']").forEach(inp=>{
    inp.addEventListener("input", e=>{
      const b = state.bidders.find(x=>x.id===e.target.dataset.id);
      if(!b) return;
      b.finance.PF1_fixed = Number(e.target.value)||0;
      saveState(); renderResults();
    });
  });
  el.querySelectorAll("input[data-act='pf2']").forEach(inp=>{
    inp.addEventListener("input", e=>{
      const b = state.bidders.find(x=>x.id===e.target.dataset.id);
      if(!b) return;
      b.finance.PF2[e.target.dataset.key] = Number(e.target.value)||0;
      saveState(); renderResults();
    });
  });
  el.querySelectorAll("input[data-act='pf31']").forEach(inp=>{
    inp.addEventListener("input", e=>{
      const b = state.bidders.find(x=>x.id===e.target.dataset.id);
      if(!b) return;
      const i = Number(e.target.dataset.idx);
      b.finance.PF3_1_tiers[i] = Number(e.target.value)||0;
      saveState(); renderResults();
    });
  });
  el.querySelectorAll("input[data-act='pf32']").forEach(inp=>{
    inp.addEventListener("input", e=>{
      const b = state.bidders.find(x=>x.id===e.target.dataset.id);
      if(!b) return;
      const i = Number(e.target.dataset.idx);
      b.finance.PF3_2_tiers[i] = Number(e.target.value)||0;
      saveState(); renderResults();
    });
  });
  el.querySelectorAll("input[data-act='tm_hourly']").forEach(inp=>{
    inp.addEventListener("input", e=>{
      const b = state.bidders.find(x=>x.id===e.target.dataset.id);
      if(!b) return;
      b.finance.tm_hourly = Number(e.target.value)||0;
      saveState(); renderResults();
    });
  });
  el.querySelectorAll("input[data-act='tm_disc']").forEach(inp=>{
    inp.addEventListener("input", e=>{
      const b = state.bidders.find(x=>x.id===e.target.dataset.id);
      if(!b) return;
      b.finance.tm_discount_pct = Number(e.target.value)||0;
      saveState(); renderResults();
    });
  });
}

function renderPf2ProbEditor(){
  const el = $("pf2ProbEditor");
  el.innerHTML = PF2_KEYS.map(k=>`
    <div class="field" style="min-width:140px; flex:1;">
      <label>${k} הסתברות %</label>
      <input type="number" step="1" min="0" max="100" value="${Number(state.settings.pf2Prob[k])||0}" data-act="pf2prob" data-key="${k}" />
    </div>
  `).join("");

  el.querySelectorAll("input[data-act='pf2prob']").forEach(inp=>{
    inp.addEventListener("input", e=>{
      const k = e.target.dataset.key;
      state.settings.pf2Prob[k] = clamp(e.target.value, 0, 100);
      saveState(); renderFinanceInputs(); renderResults();
    });
  });
}

function renderResults(){
  const el = $("results");
  if(state.bidders.length === 0){
    el.innerHTML = `<div class="hint">הוסף מציע/ים כדי לקבל תוצאות.</div>`;
    return;
  }

  // sync settings inputs (if exist)
  if($("wTech")) $("wTech").value = state.settings.wTech;
  if($("wFin")) $("wFin").value = state.settings.wFin;
  if($("tmHours")) $("tmHours").value = state.settings.tmHours;
  if($("tmDiscountCap")) $("tmDiscountCap").value = state.settings.tmDiscountCap;
  if($("tmWeightInFinance")) $("tmWeightInFinance").value = state.settings.tmWeightInFinance;

  const { rows, wT, wF, minCost } = calcAll();

  const table = `
    <div class="row" style="margin-bottom:10px;">
      <span class="pill">משקולות: <span class="mono">Tech=${wT.toFixed(3)}</span>, <span class="mono">Fin=${wF.toFixed(3)}</span></span>
      <span class="pill">Min Finance Cost: <span class="mono">${fmt(minCost,2)}</span></span>
    </div>

    <div style="overflow:auto; border:1px solid var(--line); border-radius:14px;">
      <table>
        <thead>
          <tr>
            <th>דירוג</th>
            <th>מציע</th>
            <th class="ltr">TechScore</th>
            <th class="ltr">FinanceCost</th>
            <th class="ltr">FinanceScore</th>
            <th class="ltr">TotalScore</th>
            <th class="ltr">פירוט</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map((r,i)=>{
            const cls = i===0 ? "ok" : (i===1 ? "warn" : "");
            return `
              <tr>
                <td class="right"><span class="${cls}">${i+1}</span></td>
                <td class="right"><b>${escapeHtml(r.bidder.name)}</b></td>
                <td class="ltr">${fmt(r.techScore,2)}</td>
                <td class="ltr">${fmt(r.financeCost,2)}</td>
                <td class="ltr">${fmt(r.financeScore,2)}</td>
                <td class="ltr"><b class="${cls}">${fmt(r.totalScore,2)}</b></td>
                <td class="ltr">
                  <div class="small">
                    PF_fixed=${fmt(r.pfFixed,2)} |
                    PF3.1=${fmt(r.pf31,2)} |
                    PF3.2=${fmt(r.pf32,2)} |
                    T&M=${fmt(r.tmCost,2)}
                  </div>
                </td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
    </div>
  `;

  el.innerHTML = table;
}

function renderTechInputs(){ /* overwritten above (kept for clarity) */ }

/* ========= Tab handling ========= */
$("tabs").addEventListener("click", (e)=>{
  const btn = e.target.closest(".tabbtn");
  if(!btn) return;
  document.querySelectorAll(".tabbtn").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");

  const tabId = btn.dataset.tab;
  ["tab1","tab2","tab3","tab4","tab5"].forEach(id=>{
    $(id).style.display = (id===tabId) ? "" : "none";
  });
});

/* ========= Buttons ========= */
$("btnAddBidder").addEventListener("click", ()=>{
  const name = $("newBidderName").value.trim() || `מציע ${state.bidders.length+1}`;
  state.bidders.push(makeBidder(name));
  $("newBidderName").value = "";
  renderAll();
});

$("btnLoadExample").addEventListener("click", ()=>{
  state = makeEmptyState();
  const a = makeBidder("מציע א׳");
  const b = makeBidder("מציע ב׳");
  // example tech
  DEFAULT_TECH_WEIGHTS.forEach(x=>{
    a.tech[x.key] = 85;
    b.tech[x.key] = 78;
  });
  // example finance
  a.finance.PF1_fixed = 1000000;
  b.finance.PF1_fixed = 940000;

  PF2_KEYS.forEach(k=>{
    a.finance.PF2[k] = 50000;
    b.finance.PF2[k] = 52000;
  });

  a.finance.PF3_1_tiers = [1200,1100,1050,980,950,900];
  b.finance.PF3_1_tiers = [1250,1120,1080,990,960,910];

  a.finance.PF3_2_tiers = [250000,240000,235000,230000];
  b.finance.PF3_2_tiers = [255000,238000,233000,228000];

  a.finance.tm_hourly = 550;
  a.finance.tm_discount_pct = 5;
  b.finance.tm_hourly = 520;
  b.finance.tm_discount_pct = 2;

  state.bidders.push(a,b);
  renderAll();
});

$("btnClearAll").addEventListener("click", ()=>{
  if(!confirm("למחוק הכל?")) return;
  state = makeEmptyState();
  saveState();
  renderAll();
});

$("btnRecalc").addEventListener("click", ()=> renderResults());

$("btnExportJson").addEventListener("click", ()=>{
  const payload = {
    exported_at: new Date().toISOString(),
    state
  };
  downloadFile("tender_calc_export.json", JSON.stringify(payload, null, 2), "application/json");
});

$("btnExportCsv").addEventListener("click", ()=>{
  const { rows } = calcAll();
  const header = ["rank","name","techScore","financeCost","financeScore","totalScore"].join(",");
  const lines = rows.map((r,i)=>[
    i+1,
    csvEscape(r.bidder.name),
    r.techScore.toFixed(2),
    r.financeCost.toFixed(2),
    r.financeScore.toFixed(2),
    r.totalScore.toFixed(2)
  ].join(","));
  downloadFile("tender_calc_results.csv", [header, ...lines].join("\n"), "text/csv;charset=utf-8");
});

/* ========= Settings bindings ========= */
["wTech","wFin","tmHours","tmDiscountCap","tmWeightInFinance"].forEach(id=>{
  $(id).addEventListener("input", ()=>{
    state.settings.wTech = Number($("wTech").value)||0.3;
    state.settings.wFin  = Number($("wFin").value)||0.7;
    state.settings.tmHours = Number($("tmHours").value)||280;
    state.settings.tmDiscountCap = Number($("tmDiscountCap").value)||10;
    state.settings.tmWeightInFinance = Number($("tmWeightInFinance").value)||0.02;
    saveState();
    renderResults();
  });
});

/* ========= Utilities ========= */
function downloadFile(filename, content, mime){
  const blob = new Blob([content], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function csvEscape(s){
  s = String(s ?? "");
  if(s.includes(",") || s.includes('"') || s.includes("\n")){
    return `"${s.replaceAll('"','""')}"`;
  }
  return s;
}

/* ========= Boot ========= */
function renderTechInputs(){ /* actual render already defined above */ }
renderAll();
</script>
</body>
</html>
